\documentclass[11pt]{article}
\usepackage[english]{babel}
\usepackage{listings}
\usepackage{xcolor} 
\usepackage{courier}
\usepackage{hyperref}

\lstset{
language=sh
,breaklines=true
,frame=single
,tabsize=2
,basicstyle=\ttfamily
,showstringspaces=false
,numbers=left
,numberstyle=\tiny\color{gray}}

\setlength\parindent{0pt}

\newcommand{\io}[1]{\textbf{#1}}

\title{SORTES - Clock}
\author{Dieter Castel (0256149) \\ Jonas Devlieghere (0256709)}
\date{\today}
 
\begin{document}
\maketitle
\newpage

\tableofcontents
\newpage

\section{User Documentation}
Two buttons allow the user to interact with the device. 
The bottommost is \io{button 1} and is used to browse trough a items such as numbers or menu items.
The topmost is \io{button 2} and is generally used to confirm your selection or to enter configuration mode.

\subsection{Configuration Mode}
To enter configuration mode from regular mode (i.e. the clock is displayed) press \io{button 2}. 
A menu will display allowing you to change the current time and alarm or quit configuration mode.
When the devices powers on, you will automatically enter configuration mode since the current time has not been set. 
This means you will not have to press \io{button 2} to enter configuration mode. 

\subsection{Setting the Clock}
To configure the current time, press \io{button 2} to enable configuration mode if not yet enabled. 
Press \io{button 1} until \io{Set time?} is displayed. 
Confirm this choice by pressing \io{button 2}.
You will be able to configure the clock in 3 simple steps respectively setting the hours, minutes and seconds. 
Use \io{button 1} to increase the value of each property. 
The input will automatically wrap around when the maximum value is reached.
For example, pressing {button 1} when the current hour value is 23 will yield a value of 0. 
Confirm each input value by pressing {button 2}. When all values are set you will return to the configuration menu.

\subsection{Setting the Alarm}
Configuring the alarm is almost identical to configuring the current time. Press \io{button 2} to enter configuration mode, navigate to \io{Set alarm?} by pressing \io{button 1} and press \io{button 2} once more. 
Follow the steps mentioned above to configure the alarm time as desired.

\section{System Documentation}
We provided a makefile to compile the source code. Run the following command:
\begin{lstlisting}
$ make clock 
\end{lstlisting}
To deploy the clock.hex file to the PIC a shell script is available. The script will start tftp and wait for input from the user. 
\begin{lstlisting}
$ ./deploy.sh 
\end{lstlisting}
Enter the following command but do not press return just yet. Reset the PIC and wait for the corresponding LED on the router to light up, then press return.
\begin{lstlisting}
put clock.hex
\end{lstlisting}
When all of this succeeds, you'll see something like this. The amount of time and bytes may differ.
\begin{lstlisting}
$ make clock 
#################### BUILD INIT ####################
sdcc -mpic16 -p18f97j60 -L /usr/local/lib/pic16 -llibio18f97j60.lib -llibdev18f97j60.lib -llibc18f.lib -L include objects/clock.o objects/LCDBlocking.o objects/newtime.o
message: using default linker script "/usr/local/share/gputils/lkr/18f97j60.lkr"
#################### BUILD DONE ####################
$ ./deploy.sh 
starting tftp to 192.168.97.6
put clock.hex
tftp> tftp> Sent 35956 bytes in 2.1 seconds
\end{lstlisting}

\section{System Design}

\subsection{Specification}

\subsection{Structural Choices}
\subsubsection{Timer}
To effectively measure time we are using a hardware timer provided by the PIC. This timer will interrupt when its buffer overflows. We prefer this method over working with software delays because of it's increase in accuracy. Software timers are more easily influenced by (possible unknown) software implementations (i.e. arithmetics).
\\\\
The timer can be operated in either 8 or 16 bit mode. This marks the length of its buffer and thus the delay between a software interrupt arises. Operating in 16 bit mode opposed to 8 bit may increase accuracy between interrupts but on the other hand might introduce a too rough granularity. A software counter is used to count the amount of interrupts between the elapse of one second. Empirical testing has shown us that this last effect is indeed a problem. Therefore, we have increased the amounts of interrupts and have chosen to operate the timer in 8 bit mode.

\subsubsection{Buttons}


\subsubsection{Time Structure}
Storing the current time can be done in a number of ways. We could've kept a counter of nano- or milliseconds since the beginning of time, the start of the device or since midnight. We chose for a different approach in order to save space. A structure with 3 fields (hours, minutes and seconds) is used to store the current time. This had the additional advantage of introducing a certain level of abstraction. Furthermore, this structure also represents the time of the alarm.  

\subsection{Technical Peculiarities}
If you want to make use of button \textbf{1} you need to set register ``INTCON3bits.INT\textbf{3}F''. For button \textbf{2} instead you need to use the register ``INTCON3bits.INT}\textbf{1}F''. This is also poorly documented.

For using structures malloc() is needed (which is included in the C library for the PIC16) but what is not included is actually creating the stack. That's why you have to manually assign space for the stack. How this is done can be seen on line 7 of listing \ref{time.c} on page \pageref{time.c}.

\appendix

\section{Source Code}
\lstinputlisting[language=C, caption={strings header file}, label=strings.h]{../src/strings.h}
\lstinputlisting[language=C, caption={clock body file}, label=clock.c]{../src/clock.c}
\lstinputlisting[language=C, caption={clockio header file}, label=clockio.h]{../src/clockio.h}
\lstinputlisting[language=C, caption={clockio body file}, label=clockio.c]{../src/clockio.c}
\lstinputlisting[language=C, caption={time header file}, label=time.h]{../src/time.h}
\lstinputlisting[language=C, caption={time body file}, label=time.c]{../src/time.c}
\end{document}
